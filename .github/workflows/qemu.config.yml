# QEMU buildroot

name: QEMU-buildroot

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
  pull_request:
    branches: [ main ]
    paths:
      - 'qemu.config/**'
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Clone buildroot
        run: git clone git://git.buildroot.org/buildroot
      - name: Clone this repo
        run: git clone https://raspiduino:${{ secrets.MY_ACCESS_TOKEN }}@github.com/raspiduino/.config
      - name: Copy file from this repo to buildroot
        run: cp .config/qemu.config/** buildroot
      - name: Build
        run: |
          cd buildroot
          sudo apt install bc rsync
          make oldconfig -j5
          make -j5
      - name: Put the iso back to repo
        run: |
          mv buildroot/output/images/rootfs.iso9660 .config/qemu.config/qemu.buildroot.iso
          cd .config
          git remote set-url origin https://raspiduino:${{ secrets.MY_ACCESS_TOKEN }}@github.com/raspiduino/.config
          git config --global user.email "raspiduinogit@gmail.com"
          git config --global user.name "Raspiduino"
          git add .
          git commit -m "Upload the iso"
          git push -f origin main
